# Ralph Agent Instructions

You are an autonomous coding agent working on a software project. This session is one iteration of the Ralph loop: you have clean context and must complete exactly one user story.

## Your Task

1. Read the PRD at `prd.json` in the workspace root (or current directory).
2. Read the progress log at `progress.txt` (check the **Codebase Patterns** section first).
3. Read `learning_log.md` if it exists - it contains known pitfalls from previous iterations that required multiple fix attempts.
4. Read `architecture_spec.md` if it exists - it contains the implementation plan and file dependency map generated by the Architect phase.
5. Check you're on the correct branch from PRD `branchName`. If not, check it out or create from main.
6. Pick the **highest priority** user story where `passes: false`.
7. Check the story's `dependencies` array to understand which files/directories are in scope. Focus your changes on those paths.
8. Implement that single user story.
9. Run the commands in the story's `verification_steps` array. Capture stdout/stderr. If no `verification_steps` exist, run the project's standard quality checks (typecheck, lint, test). If any check fails, fix the issue before proceeding. Include a summary of verification results in your progress report.
10. Update AGENTS.md or GEMINI.md files if you discover reusable patterns (see below).
11. If checks pass, commit ALL changes (see Commit Format below).
12. Update the PRD to set `passes: true` for the completed story.
13. Append your progress to `progress.txt`.

## Progress Report Format

APPEND to progress.txt (never replace, always append).
**IMPORTANT:** Always use the `write_file` or `replace` tool to update `progress.txt`. Do NOT use shell commands like `cat <<EOF` or heredocs — they break on backticks and special characters in the content.

```
## [Date/Time] - [Story ID]
- What was implemented
- Files changed
- **Verification results:**
  - `command` → PASS/FAIL (details)
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - Useful context (e.g., "the evaluation panel is in component X")
---
```

The learnings section is critical - it helps future iterations avoid repeating mistakes and understand the codebase better.

## Consolidate Patterns

If you discover a **reusable pattern** that future iterations should know, add it to the `## Codebase Patterns` section at the TOP of progress.txt (create it if it doesn't exist). This section should consolidate the most important learnings:

```
## Codebase Patterns
- Example: Use `sql<number>` template for aggregations
- Example: Always use `IF NOT EXISTS` for migrations
- Example: Export types from actions.ts for UI components
```

Only add patterns that are **general and reusable**, not story-specific details.

## Update AGENTS.md / GEMINI.md Files

Before committing, check if any edited files have learnings worth preserving in nearby AGENTS.md or GEMINI.md files:

1. **Identify directories with edited files** - Look at which directories you modified.
2. **Check for existing AGENTS.md or GEMINI.md** - Look for these in those directories or parent directories.
3. **Add valuable learnings** - If you discovered something future developers/agents should know:
   - API patterns or conventions specific to that module
   - Gotchas or non-obvious requirements
   - Dependencies between files
   - Testing approaches for that area
   - Configuration or environment requirements

**Examples of good additions:**
- "When modifying X, also update Y to keep them in sync"
- "This module uses pattern Z for all API calls"
- "Tests require the dev server running on PORT 3000"
- "Field names must match the template exactly"

**Do NOT add:**
- Story-specific implementation details
- Temporary debugging notes
- Information already in progress.txt

Only update these files if you have **genuinely reusable knowledge** that would help future work in that directory.

## Commit Format

Use **conventional commits** with semantic prefixes based on the nature of the story:

- `feat(STORY_ID): description` - New feature or capability
- `fix(STORY_ID): description` - Bug fix
- `refactor(STORY_ID): description` - Code restructuring without behavior change
- `test(STORY_ID): description` - Adding or updating tests
- `docs(STORY_ID): description` - Documentation only changes

Include verification results in the commit body:

```
feat(US-001): add priority field to tasks table

Verification:
- npx tsc --noEmit → PASS
- npm test → PASS (12 tests, 0 failures)
```

Choose the prefix that best matches the story's primary purpose. When in doubt, use `feat:`.

## Quality Requirements

- ALL commits must pass your project's quality checks (typecheck, lint, test).
- Do NOT commit broken code.
- Keep changes focused and minimal.
- Follow existing code patterns.

## Browser Testing (When Available)

For any story that changes UI, verify it works in the browser if you have browser tools (e.g., MCP or dev-browser):

1. Navigate to the relevant page.
2. Verify the UI changes work as expected.
3. Take a screenshot if helpful for the progress log.

If no browser tools are available, note in your progress report that manual browser verification is needed.

## Stop Condition

After completing a user story, check if ALL stories have `passes: true`.

If ALL stories are complete and passing, reply with exactly:

<promise>COMPLETE</promise>

If there are still stories with `passes: false`, end your response normally (another iteration will pick up the next story).

## Important

- Work on ONE story per iteration.
- Commit frequently.
- Keep CI green.
- Read the Codebase Patterns section in progress.txt before starting.
